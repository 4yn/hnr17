<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>HnR 2017</title>
	<script src="tracking-min.js"></script>
	<script src="three.js"></script>
	<style>
		body {
			position: relative;
		}

		#main-container {
			padding: 20px;
		}

		#video-wrapper {
			transform-origin: 100% 100% 0;
			transform: scale(0.5, 0.5);
			width: 300px;
			height: 225px;
			position: fixed;
			bottom: 0;
			right: 0;
		}

		.binding-title {
			font-size: 24px;
			font-weight: 300;

		}

		#update-bindings {
			margin-top: 10px;
		}

		#axis-diagram {
			margin-top: 40px;
			height: 180px;
		}

		#main-container .level {
			margin-top: 10px;
			margin-bottom: 0;
		}

		.subheader {
			font-size: 20px;
			font-weight: 300;
		}

		.condition-select {
			margin-right: 10px;
		}
	</style>
	<link rel="stylesheet" href="bulma.css">
</head>
<body>
	<div id="video-wrapper">
		<video id="camera" width="600" height="450" preload autoplay loop muted></video>
		<canvas id="screen" width="600" height="450"></canvas>
	</div>
	<div id="main-container" class="container">
		<div class="columns">
			
			<div class="column">
				<h1 class="title">Bindings</h1>
				<div class="level">
					<div class="level-left">
						<h2 class="binding-title">Mouse X</h2>
					</div>
					<div class="level-right">
						<span class="select is-large" name="axis-select">
							<select>
								<option value="none">None</option>
								<option value="x">X position</option>
								<option value="y">Y position</option>
								<option value="z">Z position</option>
							</select>
						</span>
					</div>
				</div>
				<div class="level">
					<div class="level-left">
						<h2 class="binding-title">Mouse Y</h2>
					</div>
					<div class="level-right">
						<span class="select is-large" name="axis-select">
							<select>
								<option value="none">None</option>
								<option value="x">X position</option>
								<option value="y">Y position</option>
								<option value="z">Z position</option>
							</select>
						</span>
					</div>
				</div>
				<hr/>
				<div class="level">
					<div class="level-left">
						<div class="level-item">
							<button class="button" id="click-binding-btn">Click Binding</button>
						</div>
						<div class="level-item">
							<button class="button" id="keyboard-binding-btn">Keyboard Binding</button>
						</div>
						
					</div>
				</div>
				<div class="level">
					<div class="level-left">
						<div class="level-item">
							<a class="delete"></a>
						</div>
						<div class="level-item">
							<input class="input" placeholder="Key"/>
						</div>
						
					</div>
					<div class="level-right">
						<span class="select condition-select" name="condition-select">
							<select>
								<option value="low">Low</option>
								<option value="high">High</option>
								<option value="increasing">Increasing</option>
								<option value="decreasing">Decreasing</option>
								<option value="jab">Jab</option>
							</select>
						</span>
						<span class="select variable-select" name="axis-select">
							<select>
								<option value="x">X position</option>
								<option value="y">Y position</option>
								<option value="z">Z position</option>
							</select>
						</span>
					</div>
				</div>
				<div class="level">
					<div class="level-left">
						<div class="level-item">
							<a class="delete"></a>
						</div>
						<div class="level-item">
							<span class="select condition-select">
							<select>
								<option value="left">Left Click</option>
								<option value="right">Right Click</option>
								<option value="up">Scroll Up</option>
								<option value="down">Scroll Down</option>
							</select>
						</span>
						</div>
						
					</div>
					<div class="level-right">
						<span class="select condition-select">
							<select>
								<option value="low">Low</option>
								<option value="high">High</option>
								<option value="increasing">Increasing</option>
								<option value="decreasing">Decreasing</option>
								<option value="jab">Jab</option>
							</select>
						</span>
						<span class="select variable-select">
							<select>
								<option value="x">X position</option>
								<option value="y">Y position</option>
								<option value="z">Z position</option>
							</select>
						</span>
					</div>
				</div>
			</div>
			<div class="column is-one-third">
				<h1 class="title">Settings</h1>
				<button class="button is-large is-danger">
					Disable (Ctrl+X)
				</button>
				<button class="button is-large" id="update-bindings">
					Update Bindings
				</button>
				<img src="axis_diagram.png" id="axis-diagram" alt="" class="image">
			</div>
		</div>
	</div>
	
	 
	<script>
		const {ipcRenderer} = require('electron');
		var bx = 0, by = 0, bz = 5;
		var px = 0, py = 0, pz = 0;
		var scene = new THREE.Scene();
		var tcam = new THREE.PerspectiveCamera(100, 600/450, 0.1, 1000);
		var renderer = new THREE.WebGLRenderer();
		renderer.setSize(1060, 600);
		// document.getElementById("video-wrapper").appendChild(renderer.domElement);

		var ballGeometry = new THREE.SphereGeometry(0.5, 32, 32);
		var material = new THREE.MeshBasicMaterial({color: 0x00ff00});
		var ball = new THREE.Mesh(ballGeometry, material);
		scene.add(ball);

		tcam.position.x = 0;
		tcam.position.y = 0;
		tcam.position.z = 100;


		function render() {
			requestAnimationFrame(render);
			var dx = px - bx;
			var dy = py - by;
			var dz = pz - bz;
			if (dx*dx + dy*dy + dz*dz > 0.02 * (50 - bz)) {
				px = bx;
				py = by;
				pz = bz;
				ball.position.x = px;
				ball.position.y = py;
				ball.position.z = pz;
			} else {
				px -= dx / 10;
				py -= dy / 10;
				pz -= dz / 10;
			}

			var screenx = 1920;
			var screeny = 1080;
			var a = {};

			a["x"] = (px/(width * pz * 16/600/36))*(screenx/2) + (screenx/2);
			a["y"] = -(py/(height * pz * 13/450/36))*(screeny/2) + (screeny/2);
			console.log(a);
			ipcRenderer.send('asynchronous-message', a) //-20 17, 20 -16
			renderer.render(scene, tcam);
		}

		render();
		var width = 600;
		var height = 450;

	 	tracking.ColorTracker.registerColor('tracker', function (r, g, b) {
	 		var ir = 130, ig = 60, ib = 60;
	 		var dr = (ir - r)/256;
	 		var dg = (ig - g)/256;
	 		var db = (ib - b)/256;
	 		return (dr*dr + dg*dg + db*db < 0.010);
	 	});

	 	var tracker = new tracking.ColorTracker(['yellow']);
	 	tracker.setMinDimension(10);

	 	var camera = document.getElementById('camera');
	 	var canvas = document.getElementById('screen');
	 	var context = canvas.getContext('2d');

		tracking.track('#camera', tracker, {camera: true});

		tracker.on('track', function (e) {
			context.clearRect(0, 0, 600, 450);
			if (e.data.length == 1) {
				e.data.forEach(function(rect) {

					var cx = rect.x + rect.width/2;
					var cy = rect.y + rect.height/2;
					var r = (rect.height + rect.width)/4;
					context.strokeStyle = "#ffffff";

					context.beginPath();
					context.arc(cx, cy, r, 0, Math.PI*2, true);
					context.stroke();
					context.closePath();

					var x0 = 16;
					var y0 = 13;
					var z0 = 30;
					var r0 = 36;

					bz = z0 / r * r0;
					bx = (width - 2 * cx) * bz * x0/600/z0;
					by = (height - 2 * cy) * bz * y0/450/z0;
				});
			}
		});
	 </script>
</body>
</html>